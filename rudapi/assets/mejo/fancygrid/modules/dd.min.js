!function(){var a=Fancy,b=a.GRID_BODY_CLS,c=a.GRID_CLS,d=a.GRID_CELL_CLS;a.define("Fancy.grid.plugin.GridToGrid",{extend:a.Plugin,ptype:"grid.dragdrop",inWidgetName:"dragdrop",dropOK:!1,cellMaskCls:"fancy-drop-cell-mask",dropZoneCls:"fancy-drop-zone-active",dropOkCls:"fancy-drop-ok",dropNotOkCls:"fancy-drop-not-ok",dropHeaderMaskCls:"fancy-drop-header-mask",droppable:!0,dropZoneOverClass:b,constructor:function(a){this.Super("const",arguments)},init:function(){var a=this;a.addEvents("drop"),a.Super("init",arguments),a.initDropCls(),a.initEnterLeave(),a.ons()},initDropCls:function(){var a=this,b="."+a.dropGroup;b+=" ."+a.dropZoneOverClass,a.dropCls=b},addDragDropCls:function(){this.widget.el.addCls(this.dragGroup)},ons:function(){var a=this,b=a.widget;b.on("render",function(){a.addDragDropCls()}),a.dropGroup&&(b.on("beforecellmousedown",a.onBeforeCellMouseDown,a),b.on("cellmousedown",a.onCellMouseDown,a),b.on("cellleave",a.onCellLeave,a),b.on("cellenter",a.onCellEnter,a)),a.on("drop",a.onDropItems,a)},onDropItems:function(a,b){var c=this,d=c.widget,e=c.dropGrid,f=void 0===e.activeRowEnterIndex?e.getViewTotal():e.activeRowEnterIndex;d.fire("dropitems",b,f),c.onDrop&&c.onDrop.apply(d,[b,f])},onBeforeCellMouseDown:function(b,c){var d=this,e=d.widget,f=e.lang,g=a.get(document),h=e.getSelection();if((!c.e.ctrlKey||!0!==e.multiSelect)&&h.length>1){var i=!1;if(a.each(h,function(a){if(a.id===c.id)return i=!0,!0}),!1===i)return;e.stopSelection(),g.once("mouseup",d.onDocMouseUp,d),g.on("mousemove",d.onDocMouseMove,d),g.once("mouseup",function(){e.enableSelection()},d),h=e.getSelection();var j=a.String.format(f.dragText,[h.length,h.length>1?"s":""]);d.initTip(j),d.dragItems=e.getSelection(),d.cellMouseDown=!0}},onCellMouseDown:function(b,c){var d=this,e=d.widget,f=a.get(document);if(!1!==e.selection.enabled){c.e.ctrlKey&&!0===e.multiSelect||("$selected"===c.column.index||e.clearSelection(),f.once("mouseup",d.onDocMouseUp,d),f.on("mousemove",d.onDocMouseMove,d),d.cellMouseDown=!0,d.activeRowIndex=c.rowIndex)}},initEnterLeave:function(){var b=this,c=a.select(b.dropCls);if(0===c.length)return void setTimeout(function(){b.initEnterLeave()},500);c.on("mouseenter",b.onMouseEnterDropGroup,b),c.on("mouseleave",b.onMouseLeaveDropGroup,b)},onMouseEnterDropGroup:function(b){var d=this;if(d.cellMouseDown){var e=a.get(b.currentTarget);if(d.dropGrid=a.getWidget(e.closest("."+c).attr("id")),d.dropGrid&&d.dropGrid.dragdrop&&!1===d.dropGrid.dragdrop.droppable)return d.dropOK=!1,void(d.tip&&d.tip.el.replaceClass(d.dropOkCls,d.dropNotOkCls));d.setDropGridCellsMask(),d.dropGridEventInited||d.onsDropGrid(),e.addCls(d.dropZoneCls),d.dropOK=!0,d.tip&&d.tip.el.replaceClass(d.dropNotOkCls,d.dropOkCls)}},onMouseLeaveDropGroup:function(b){var c=this;c.cellMouseDown&&(a.get(b.currentTarget).removeCls(c.dropZoneCls),c.dropOK=!1,c.tip.el.replaceClass(c.dropOkCls,c.dropNotOkCls),c.clearCellsMask())},setDropGridCellsMask:function(){var a,b=this,c=b.dropGrid;c&&b.cellMouseDown&&(a=c.getTotal(),0===a?c.el.addCls(b.dropHeaderMaskCls):c.el.select("."+d+'[index="'+(a-1)+'"]').addCls(b.cellMaskCls))},onsDropGrid:function(){var a=this;a.dropGrid.on("rowenter",a.onDropGridRowEnter,a),a.dropGrid.on("rowleave",a.onDropGridRowLeave,a),a.dropGridEventInited=!0},onDropGridRowEnter:function(a,b){var c=this;!1===c.cellMouseDown&&(c.dropGrid.un("rowenter",c.onDropGridRowEnter),c.dropGrid.un("rowleave",c.onDropGridRowLeave)),c.clearCellsMask(),0===b.rowIndex?a.el.addCls(c.dropHeaderMaskCls):a.el.select("."+d+'[index="'+(b.rowIndex-1)+'"]').addCls(c.cellMaskCls),!1===c.cellMouseDown&&c.clearCellsMask(),c.dropGrid&&(c.dropGrid.activeRowEnterIndex=b.rowIndex)},onDropGridRowLeave:function(a,b){var c=this;c.clearCellsMask(),c.setDropGridCellsMask(),c.dropGrid&&delete c.dropGrid.activeRowEnterIndex},clearCellsMask:function(){var a=this,b=a.cellMaskCls;a.dropGrid&&(a.dropGrid.el.removeCls(a.dropHeaderMaskCls),a.dropGrid.el.select("."+b).removeCls(b))},onDocMouseUp:function(b){var c=this,d=c.widget,e=a.get(document);c.cellMouseDown=!1,c.tip&&c.tip.hide(),d.enableSelection(),e.un("mousemove",c.onDocMouseMove),!0===c.dropOK&&(d.clearSelection(),c.dropGrid.clearSelection(),c.fire("drop",c.dragItems)),delete c.dragItems,c.dropOK=!1,a.select("."+c.dropZoneCls).removeCls(c.dropZoneCls),c.clearCellsMask(),c.dropGrid&&(c.dropGrid.un("rowenter",c.onDropGridRowEnter),c.dropGrid.un("rowleave",c.onDropGridRowLeave)),delete c.dropGridEventInited},onDocMouseMove:function(a){this.dragItems&&this.tip.show(a.pageX+20,a.pageY+20)},onCellLeave:function(b,c){var d=this,e=d.widget,f=e.lang;setTimeout(function(){if(d.onceStopDrag)return void(d.onceStopDrag=!1);if(!0===d.cellMouseDown&&!d.dragItems){var b=e.getSelection(),g=a.String.format(f.dragText,[b.length,b.length>1?"s":""]);e.stopSelection(),d.initTip(g,c.e),d.tip.show(),d.tip.el.css("display","block"),d.dragItems=b}},1)},onCellEnter:function(a,b){var c=this;!0!==c.cellMouseDown||c.dragItems||b.rowIndex!==c.activeRowIndex&&(c.onceStopDrag=!0,c.activeRowIndex=b.rowIndex)},initTip:function(b,c){var d=this,e=d.dropNotOkCls;d.tip||(d.tip=new a.ToolTip({cls:e,text:b})),c&&d.tip.show(c.pageX+20,c.pageY+20),d.tip.update(b),d.tip.el.replaceClass(d.dropOkCls,e)}})}();