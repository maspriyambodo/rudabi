Fancy.Mixin("Fancy.store.mixin.Filter",{filterCheckItem:function(a){var b=this,c=b.filters,d=!0,e=!1;for(var f in c){var g=c[f],h=a.data[f];if(b.smartIndexes&&b.smartIndexes[f])h=b.smartIndexes[f](a.data);else if(/\./.test(f)){var i=f.split(".");h=a.data[i[0]][i[1]]}"date"===g.type&&(h=Number(Fancy.Date.parse(h,g.format.read,g.format.mode)));for(var j in g){switch(j){case"type":case"format":continue}var k=g[j];switch(j){case"<":d=Number(h)<k;break;case">":d=Number(h)>k;break;case"<=":d=Number(h)<=k;break;case">=":d=Number(h)>=k;break;case"=":case"==":Fancy.isArray(k)?(h=String(h),d=-1!==k.indexOf(h)):d=h==k;break;case"===":Fancy.isArray(k)?(h=String(h),d=-1!==k.indexOf(h)):d=h===k;break;case"!==":d=h!==k;break;case"!=":d=h!=k;break;case"":k=String(k).toLocaleLowerCase(),h=String(h).toLocaleLowerCase(),k=k.replace(/\(/g,"bracketleft"),k=k.replace(/\)/g,"bracketright"),h=h.replace(/\(/g,"bracketleft"),h=h.replace(/\)/g,"bracketright"),d=new RegExp(k).test(h);break;case"*":d=new RegExp(String(k).toLocaleLowerCase()).test(String(h).toLocaleLowerCase()),e=!0;break;case"|":d=!0===k[String(h).toLocaleLowerCase()];break;default:throw new Error("FancyGrid Error 5: Unknown filter "+j)}if(!0===e){if(!0===d)return!0}else if(!1===d)return!1}}return!0!==e||!1!==d},filterData:function(){var a=this,b=a.data,c=[],d=0,e=b.length,f=[],g=[];for(a.remoteFilter&&a.serverFilter();d<e;d++)a.order?(f.push(a.order[d]),g=b[a.order[d]]):(f.push(d),g=b[d]),a.filterCheckItem(g)&&c.push(g);a.filterOrder=f,a.filteredData=c,a.paging&&a.calcPages(),a.fire("filter")},serverFilter:function(){var a=this,b="[",c=a.filters||{};for(var d in c){var e=c[d];for(var f in e){switch(f){case"type":case"format":continue}var g=a.filterOperators[f];if("or"===g){var h=[];for(var i in e[f])h.push(i);b+='{"operator":"'+g+'","value":"'+h.join(", ")+'","property":"'+d+'"},'}else b+='{"operator":"'+g+'","value":"'+e[f]+'","property":"'+d+'"},'}}b=b.replace(/\,$/,""),b+="]",a.params=a.params||{},"[]"===b?(b="",delete a.params[a.filterParam]):a.params[a.filterParam]=encodeURIComponent(b),a.loadData()}}),function(){var a=Fancy,b=Fancy.Date,c=a.FIELD_CLS,d=a.GRID_HEADER_CELL_DOUBLE_CLS,e=a.GRID_HEADER_CELL_TRIPLE_CLS,f=a.GRID_HEADER_CELL_FILTER_CLS,g=a.GRID_HEADER_CELL_FILTER_FULL_CLS,h=a.GRID_HEADER_CELL_FILTER_SMALL_CLS;a.define("Fancy.grid.plugin.Filter",{extend:a.Plugin,ptype:"grid.filter",inWidgetName:"filter",autoEnterDelay:500,constructor:function(a){this.filters={},this.Super("const",arguments)},init:function(){this.Super("init",arguments),this.ons()},ons:function(){var a=this,b=a.widget;b.once("render",function(){a.render()}),b.on("columnresize",a.onColumnResize,a),b.on("filter",a.onFilter,a),b.on("lockcolumn",a.onLockColumn,a),b.on("rightlockcolumn",a.onRightLockColumn,a),b.on("unlockcolumn",a.onUnLockColumn,a),b.on("columndrag",a.onColumnDrag,a)},render:function(){var a=this,b=a.widget;a._renderSideFields(b.header,b.columns),a._renderSideFields(b.leftHeader,b.leftColumns),a._renderSideFields(b.rightHeader,b.rightColumns)},_renderSideFields:function(a,b){for(var c,g,h=this,i=0,j=b.length;i<j;i++)g=b[i],c=a.getCell(i),g.filter&&g.filter.header?(h.renderFilter(g.type,g,c),h.groupHeader&&!g.grouping&&c.addCls(e),c.addCls(f)):h.header&&(h.groupHeader&&!g.grouping?c.addCls(e):g.grouping&&h.groupHeader?c.addCls(d):g.grouping||c.addCls(d))},_clearColumnsFields:function(b,d,e,f){for(var g,h=0,i=b.length;h<i;h++)if(g=b[h],g.filter&&g.filter.header){if(e&&g.index!==e)continue;switch(g.type){case"date":var j=d.getCell(h).select("."+c),k=a.getWidget(j.item(0).attr("id")),l=a.getWidget(j.item(1).attr("id"));k.clear(),l.clear();break;default:var m=d.getCell(h).select("."+c).attr("id"),n=a.getWidget(m);if(f){var o=n.get().split(",");if(o.length<2&&!f)n.clear();else{for(var p=0,q=o.length,r="";p<q;p++){var s=o[p];new RegExp(f).test(s)||(r+=s)}n.set(r)}}else n.clear()}}},clearColumnsFields:function(a,b){var c=this,d=c.widget;c._clearColumnsFields(d.columns,d.header,a,b),c._clearColumnsFields(d.leftColumns,d.leftHeader,a,b),c._clearColumnsFields(d.rightColumns,d.rightHeader,a,b)},_addValuesInColumnFields:function(b,d,e,f,g){for(var h,i=0,j=b.length;i<j;i++)if(h=b[i],h.index===e&&h.filter&&h.filter.header)switch(h.type){case"date":var k=d.getCell(i).select("."+c),l=a.getWidget(k.item(0).attr("id")),m=a.getWidget(k.item(1).attr("id"));l.clear(),m.clear();break;default:var n=d.getCell(i).select("."+c).attr("id"),o=a.getWidget(n),p=o.get(),q=o.get().split(",");if(1===q.length&&""===q[0])o.set((g||"")+f);else if(1===q.length)new RegExp(g).test(p)?o.set((g||"")+f):o.set(p+","+(g||"")+f);else{for(var r=0,s=q.length,t="";r<s;r++){var u=q[r];new RegExp(g).test(u)?(0!==t.length&&(t+=","),t+=(g||"")+f):(0!==t.length&&(t+=","),t+=u)}o.set(t)}}},addValuesInColumnFields:function(a,b,c){var d=this,e=d.widget;d._addValuesInColumnFields(e.columns,e.header,a,b,c),d._addValuesInColumnFields(e.leftColumns,e.leftHeader,a,b,c),d._addValuesInColumnFields(e.rightColumns,e.rightHeader,a,b,c)},renderFilter:function(b,c,d){var e,f=this,g=f.widget,h={position:"absolute",bottom:"3px"},i=c.filter,j=g.theme,k=i.tip;switch(b){case"date":var l=[];l.push({change:f.onDateChange,scope:f});if(a.isString(c.format))switch(c.format){case"date":c.format}e=new a.DateRangeField({renderTo:d.dom,value:new Date,format:c.format,label:!1,padding:!1,style:h,events:l,width:c.width-8,emptyText:i.emptyText,dateImage:!1,theme:j});break;case"string":var l=[{enter:f.onEnter,scope:f}];!1!==f.autoEnterDelay&&l.push({key:f.onKey,scope:f}),e=new a.StringField({renderTo:d.dom,label:!1,padding:!1,style:h,events:l,emptyText:i.emptyText,tip:k});break;case"number":case"grossloss":case"progressbar":case"progressdonut":var l=[{enter:f.onEnter,scope:f}];!1!==f.autoEnterDelay&&l.push({key:f.onKey,scope:f}),e=new a.NumberField({renderTo:d.dom,label:!1,padding:!1,style:h,emptyText:i.emptyText,events:l,tip:k});break;case"combo":var m,n="text",o="text";void 0!==c.displayKey&&(n=c.displayKey,o=n),m=a.isObject(c.data)||a.isObject(c.data[0])?c.data:f.configComboData(c.data),e=new a.Combo({renderTo:d.dom,label:!1,padding:!1,style:h,width:c.width-8,displayKey:n,valueKey:o,value:"",height:28,emptyText:i.emptyText,theme:j,tip:k,multiSelect:c.multiSelect,itemCheckBox:c.itemCheckBox,minListWidth:c.minListWidth,events:[{change:f.onEnter,scope:f},{empty:function(){this.set(-1)}}],data:m});break;case"checkbox":e=new a.Combo({renderTo:d.dom,label:!1,padding:!1,style:h,displayKey:"text",valueKey:"value",width:c.width-8,emptyText:i.emptyText,value:"",editable:!1,events:[{change:f.onEnter,scope:f}],data:[{value:"",text:""},{value:"false",text:g.lang.no},{value:"true",text:g.lang.yes}]});break;default:var l=[{enter:f.onEnter,scope:f}];!1!==f.autoEnterDelay&&l.push({key:f.onKey,scope:f}),e=new a.StringField({renderTo:d.dom,label:!1,style:h,padding:!1,emptyText:i.emptyText,events:l})}switch(e.filterIndex=c.index,e.column=c,"date"!==b&&(e.el.css("padding-left","4px"),e.el.css("padding-top","0px")),b){case"checkbox":case"combo":case"date":break;default:e.setInputSize({width:c.width-8})}c.filterField=e},onEnter:function(b,c,d){var e=this,f=e.widget,g=f.store,h=b.filterIndex;if(d=d||{},e.intervalAutoEnter&&(clearInterval(e.intervalAutoEnter),e.intervalAutoEnter=!1),delete e.intervalAutoEnter,0===c.length)return e.filters[b.filterIndex]={},e.updateStoreFilters(),void(f.grouping&&f.grouping.reGroup());var i=e.processFilterValue(c,b.column.type),j=0,k=i.length;for(e.filters[h]={};j<k;j++){var l=i[j];""===l.operator&&b.column.filter&&b.column.filter.operator&&(l.operator=b.column.filter.operator),e.filters[h][l.operator]=l.value,l.operator,"date"===b.column.type&&a.apply(e.filters[h],d)}g.remoteFilter?(g.filters=e.filters,g.serverFilter()):e.updateStoreFilters(),f.grouping&&(g.remoteSort?g.once("load",function(){f.grouping.reGroup(),f.fire("filter",e.filters)}):f.grouping.reGroup()),f.setSidesHeight()},processFilterValue:function(b,c){var d,e,f,g,h,i={"<":!0,">":!0,"!":!0,"=":!0,"|":!0},j=0,k=3,l=[];if(a.isArray(b))return e={},a.Array.each(b,function(a,b){e[String(a).toLocaleLowerCase()]=!0}),l.push({operator:"|",value:e}),l;for(f=b.split(","),g=0,h=f.length;g<h;g++){for(j=0,d="",e=f[g];j<k;j++)i[e[j]]&&(d+=e[j]);if(e=e.replace(new RegExp("^"+d),""),!(e.length<1)){switch(c){case"number":e=Number(e);break;case"combo":d="="}l.push({operator:d,value:e})}}return l},updateStoreFilters:function(){var a=this,b=a.widget,c=b.store,d=!1;c.filters=a.filters;for(var e in c.filters){if(c.filters[e]){d=!0;break}}d||delete c.filteredData,c.changeDataView(),b.update(),b.fire("filter",a.filters),b.setSidesHeight(),d||delete c.filteredData},onColumnResize:function(b,d){var e,f=a.get(d.cell),g=d.width,h=f.select("."+c);0===h.length||(2===h.length?(e=a.getWidget(h.item(0).dom.id),e.setWidth((g-8)/2),e=a.getWidget(h.item(1).dom.id),e.setWidth((g-8)/2)):(e=a.getWidget(h.dom.id),"field.combo"===e.wtype?(e.size({width:g-8}),e.el.css("width",g-8+5)):e.setInputSize({width:g-8})))},onKey:function(b,c,d){var e=this;d.keyCode!==a.key.ENTER&&(e.autoEnterTime=+new Date,e.intervalAutoEnter||(e.intervalAutoEnter=setInterval(function(){var a=new Date;e.intervalAutoEnter&&a-e.autoEnterTime>e.autoEnterDelay&&(clearInterval(e.intervalAutoEnter),delete e.intervalAutoEnter,c=b.getValue(),e.onEnter(b,c))},200)))},onDateChange:function(c,d){var e,f,g,h=this,i=h.widget,j=c.format,k=i.store,l=c.dateField1.getDate(),m=c.dateField2.getDate(),n="Invalid Date"!==l.toString()&&a.isDate(l),o="Invalid Date"!==m.toString()&&a.isDate(m),p=k.remoteFilter;n&&(l=new Date(l.getFullYear(),l.getMonth(),l.getDate())),o&&(m=new Date(m.getFullYear(),m.getMonth(),m.getDate())),n&&o?(!0!==p?(f=Number(l),g=Number(m)):(f=b.format(l,j.edit,j.mode),g=b.format(m,j.edit,j.mode)),e=">="+f+",<="+g):n?(e=!0!==p?">="+Number(l):">="+b.format(l,j.edit,j.mode),h.clearFilter(c.filterIndex,"<=",!1)):o?(e=!0!==p?"<="+Number(m):"<="+b.format(l,j.edit,j.mode),h.clearFilter(c.filterIndex,">=",!1)):h.clearFilter(c.filterIndex),e&&h.onEnter(c,e,{type:"date",format:c.format})},clearFilter:function(a,b,c){var d=this;void 0===b?delete d.filters[a]:d.filters[a]&&delete d.filters[a][b],!1!==c&&d.updateStoreFilters()},onFilter:function(){this.widget.scroll(0)},configComboData:function(b){var c=0,d=b.length,e=[];if(a.isObject(b))return b;for(;c<d;c++)e.push({value:c,text:b[c]});return e},destroyFields:function(){var b=this,c=b.widget;a.each(c.columns,function(a){a.filterField&&(a.filterField.destroy(),delete a.filterField)}),a.each(c.leftColumns,function(a){a.filterField&&(a.filterField.destroy(),delete a.filterField)}),a.each(c.rightColumns,function(a){a.filterField&&(a.filterField.destroy(),delete a.filterField)}),c.el.select("."+f).removeCls(f),c.el.select("."+g).removeCls(g),c.el.select("."+h).removeCls(h),c.el.select("."+d).removeCls(d),c.el.select("."+e).removeCls(e)},onLockColumn:function(){this.render()},onUnLockColumn:function(){this.render()},onRightLockColumn:function(){this.render()},onColumnDrag:function(){var a=this;a.destroyFields(),a.render()}})}(),Fancy.define("Fancy.grid.plugin.Search",{extend:Fancy.Plugin,ptype:"grid.search",inWidgetName:"searching",autoEnterDelay:500,constructor:function(a){this.searches={},this.Super("const",arguments)},init:function(){this.Super("init",arguments),this.ons()},ons:function(){var a=this;a.widget.once("init",function(){a.generateKeys()})},search:function(a,b){var c=this,d=c.widget,e=d.store;if(c.searches={},!a&&!b)return c.clear(),c.updateStoreSearches(),void(d.grouping&&d.grouping.reGroup());!1!==Fancy.isArray(a)||b||(c.searches=a),c.setFilters(),e.remoteSort?e.serverFilter():c.updateStoreSearches(),d.grouping&&(e.remoteSort?e.once("load",function(){d.grouping.reGroup()}):d.grouping.reGroup())},updateStoreSearches:function(){var a=this.widget;a.store.changeDataView(),a.update()},setKeys:function(a){var b=this;b.keys=a,b.setFilters(),b.updateStoreSearches()},generateKeys:function(){var a=this,b=a.widget;if(!a.keys){a.keys={};var c=[];b.columns&&(c=c.concat(b.columns)),b.leftColumns&&(c=c.concat(b.leftColumns)),b.rightColumns&&(c=c.concat(b.rightColumns));var d=[];Fancy.each(c,function(a){var b=a.index||a.key;if(!1!==a.searchable){switch(a.type){case"color":case"combo":case"date":case"number":case"string":case"text":case"currency":break;default:return}b&&d.push(b)}}),Fancy.each(d,function(b){"$selected"!==b&&(a.keys[b]=!0)})}return a.keys},setFilters:function(){var a=this,b=a.widget,c=b.store,d=c.filters||{};if(void 0===a.searches||Fancy.isObject(a.searches))return void a.clear();for(var e in a.keys)!1!==a.keys[e]?(d[e]=d[e]||{},d[e]["*"]=a.searches):d[e]&&delete d[e]["*"];a.filters=d,c.filters=d},clear:function(){var a=this,b=a.widget,c=b.store,d=c.filters||{};for(var e in a.keys)void 0!==d[e]&&delete d[e]["*"];a.filters=d,c.filters=d,delete a.searches}});