Fancy.Mixin("Fancy.store.mixin.Sort",{multiSortLimit:3,sort:function(a,b,c,d){var e,f,g=this;switch(g.fire("beforesort",{key:"key",action:a}),g.multiSort&&!0!==g.multiSortInited&&g.initMultiSort(),b){case"number":case"checkbox":case"progressdonut":case"progressbar":case"grossloss":case"date":case"currency":e="sortNumber",f="number";break;case"string":case"combo":case"text":case"color":e="sortString",f="string";break;default:throw new Error("[FancyGrid error] - does not exist sort function for type "+b)}if(g.multiSort&&g.addSorter(c,a.toLocaleUpperCase(),f),g.remoteSort)return void g.serverSort(a,b,c);if(d.type=b,g[e](a,c,d),g.multiSort)for(var h=0,i=g.sorters.length-1;h<i;h++)g.multiSortOrder(h);g.changeDataView(),g.fire("sort",{key:"key",action:a})},serverSort:function(a,b,c){var d=this;d.params=d.params||{},d.multiSort?d.params.sorters=d.sorters:(d.params[d.sortParam]=c,d.params[d.directionParam]=a),d.loadData()},sortNumber:function(a,b,c){var d,e,f,g=this,h=[];if(g.grouping){var i=g.getColumnOriginalValuesByGroup(b,g.grouping.by,c);switch(d=[],e=0,f=i.length,a){case"asc":for(;e<f;e++)h=h.concat(i[e].values),d=d.concat(i[e].values.sort(function(a,b){return a-b}));break;case"desc":for(;e<f;e++)h=h.concat(i[e].values),d=d.concat(i[e].values.sort(function(a,b){return b-a}))}}else{h=g.getColumnOriginalValues(b,c);for(var j=[],k=Fancy.Array.copy(h),e=0,f=k.length;e<f;e++)isNaN(k[e])&&(j.push(k[e]),k.splice(e,1),f--);switch(a){case"asc":d=Fancy.Array.copy(k).sort(function(a,b){return a-b}),d=d.concat(j);break;case"desc":d=Fancy.Array.copy(k).sort(function(a,b){return b-a}),d=j.concat(d)}}g.order=g.getOrder(h,d)},sortString:function(a,b){var c,d,e,f=this,g=[];if(f.grouping){var h=f.getColumnOriginalValuesByGroup(b,f.grouping.by);switch(c=[],d=0,e=h.length,a){case"asc":for(;d<e;d++)g=g.concat(h[d].values),c=c.concat(h[d].values.sort());break;case"desc":for(;d<e;d++)g=g.concat(h[d].values),c=c.concat(h[d].values.sort().reverse())}}else switch(g=f.getColumnOriginalValues(b),a){case"asc":c=Fancy.Array.copy(g).sort();break;case"desc":c=Fancy.Array.copy(g).sort(),c=c.reverse()}f.order=f.getOrder(g,c)},getOrder:function(a,b){for(var c,d={},e=0,f=a.length,g=[];e<f;e++){var h=a[e];void 0===d[h]&&(d[h]=[]),d[h].push(e)}for(e=0;e<f;e++)h=b[e],c=d[h],g.push(c[0]),c.length>1&&c.splice(0,1);return g},changeOrderIndexes:function(a,b){var c=this;if(void 0===b&&(b="-"),void 0!==c.order){var d=0,e=c.order.length;if("-"===b)for(;d<e;d++)c.order[d]>a&&c.order[d]--;else for(;d<e;d++)c.order[d]>=a&&c.order[d]++}},initMultiSort:function(){var a=this;a.multiSortInited=!0,a.sorters||(a.sorters=[])},addSorter:function(a,b,c){for(var d=this,e=0,f=d.sorters.length;e<f;e++)if(d.sorters[e].key===a){d.sorters.splice(e,1);break}d.sorters.push({key:a,dir:b.toLocaleUpperCase(),type:c}),d.sorters.length>d.multiSortLimit&&d.sorters.shift()},multiSortOrder:function(a){for(var b,c,d,e=this,f=e.widget,g=f.store,h=e.sorters[a],i=e.sorters[a+1].key,j=h.key,k=0,l=e.getTotal(),m=[],n=[],o=[];k<l;k++)b=g.get(e.order[k],i,!0),d=g.get(e.order[k],j,!0),b===c?(m[m.length-1].push(d),n[n.length-1].push(e.order[k])):(m.push([d]),n.push([e.order[k]])),c=b;for(k=0,l=n.length;k<l;k++)if(1!==n[k].length){var p;if("number"===h.type)switch(h.dir){case"ASC":p=Fancy.Array.copy(m[k]).sort(function(a,b){return a-b});break;case"DESC":p=Fancy.Array.copy(m[k]).sort(function(a,b){return b-a})}else if("string"===h.type)switch(h.dir){case"ASC":p=Fancy.Array.copy(m[k]).sort();break;case"DESC":p=Fancy.Array.copy(m[k]).sort().reverse()}var q,r=n[k],s=[];q=e.getOrder(m[k],p);for(var t=0,u=q.length;t<u;t++)s.push(r[q[t]]);o=o.concat(s)}else o.push(n[k][0]);e.order=o}}),function(){var a=Fancy,b=a.GRID_COLUMN_SORT_ASC,c=a.GRID_COLUMN_SORT_DESC,d=a.GRID_COLUMN_RESIZER_CLS,e=a.FIELD_CLS,f=a.GRID_CENTER_CLS,g=a.GRID_LEFT_CLS,h=a.GRID_RIGHT_CLS;a.define("Fancy.grid.plugin.Sorter",{extend:a.Plugin,ptype:"grid.sorter",inWidgetName:"sorter",constructor:function(a){this.Super("const",arguments)},init:function(){this.Super("init",arguments),this.ons()},ons:function(){var a=this;a.widget.once("render",function(){a.onsHeaders()})},onsHeaders:function(){var a=this;a.widget.on("headercellclick",a.onHeaderCellClick,a)},onHeaderCellClick:function(f,g){var h,i,j,k,l=this,m=l.widget,n=a.get(g.cell),o=g.side,p=g.index,q=g.e,r=q.target;if("input"!==r.tagName.toLocaleLowerCase()){var s=n.select("."+e);s.length>0&&!0===s.item(0).within(r)||n.hasCls(d)||m.startResizing||(i=m.getColumns(o),h=n.hasCls(b)?"desc":(n.hasCls(c),"asc"),j=i[p],k=j.index||j.key,l.sort(h,k,o,j,n))}},sort:function(d,e,f,g,h){var i,j=this,k=j.widget,l=k.store,m=k.getColumns(f),n=0,o=m.length,p=k.getHeader(f);if(!g||!h)for(;n<o;n++)if(m[n].index===e){g=m[n],h=p.getCell(n);break}if(!0===g.sortable){switch(k.multiSort?j.clearHeaderMultiSortCls(d,h):j.clearHeaderSortCls(),d){case"asc":h.addCls(b);break;case"desc":h.addCls(c)}i=g.type;var q,r;if(g.format)if(a.isString(g.format))switch(g.format){case"date":q=k.lang.date.read,g.format.mode&&(r=g.format.mode)}else switch(g.type){case"date":q=g.format.read,g.format.mode&&(r=g.format.mode)}k.grouping&&l.remoteSort&&l.once("load",function(){k.grouping.reGroup()}),l.sort(d,i,e,{smartIndexFn:g.smartIndexFn,format:q,mode:r})}},clearHeaderMultiSortCls:function(a,d){var e,i,j=this,k=j.widget,l=k.store;switch(a.toLocaleUpperCase()){case"ASC":d.removeCls(c);break;case"DESC":d.removeCls(b)}if(e=k.el.select("."+b),i=k.el.select("."+c),!(e.length+i.length<3)){for(var m,n=0,o=e.length;n<o;n++){var p,q,r,s=e.item(n),t=s.parent().parent(),u=s.attr("index");t.hasCls(f)?p="center":t.hasCls(g)?p="left":t.hasCls(h)&&(p="right"),q=k.getColumns(p),r=q[u].index;var v=l.sorters[0];v.key===r&&(m=s)}for(var n=0,o=i.length;n<o;n++){var p,q,r,s=i.item(n),t=s.parent().parent(),u=s.attr("index");t.hasCls(f)?p="center":t.hasCls(g)?p="left":t.hasCls(h)&&(p="right"),q=k.getColumns(p),r=q[u].index;var v=l.sorters[0];v.key===r&&(m=s)}m.removeCls(b),m.removeCls(c)}},clearHeaderSortCls:function(){var a=this.widget.el;a.select("."+b).removeCls(b),a.select("."+c).removeCls(c)}})}();